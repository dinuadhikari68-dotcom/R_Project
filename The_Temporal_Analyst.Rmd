---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 


## Scenario A: The Temporal Analyst


```{r}
library(tidyverse)
```

```{r}
library(readxl)

air_data <- read_excel("who_ambient_air_quality_database_version_2024_(v6.1) (3).xlsx", 
                       sheet = "Update 2024 (V6.1)")

head(air_data)

```

```{r}
# Remove missing values for key columns (example: year and PM2.5)
air_clean <- air_data %>%
  filter(!is.na(pm25_concentration), !is.na(year)) %>%
  filter(year >= 2010 & year <= 2022)

# Convert data types
air_clean$year <- as.numeric(air_clean$year)

# Check summary
summarytools::dfSummary(air_clean)

```


```{r}
# Load tidyverse for convenient data manipulation
library(tidyverse)

# Convert numeric variables (from character to numeric)
air_data <- air_data %>%
  mutate(
    pm10_concentration  = as.numeric(pm10_concentration),
    pm25_concentration  = as.numeric(pm25_concentration),
    no2_concentration   = as.numeric(no2_concentration),
    pm10_tempcov        = as.numeric(pm10_tempcov),
    pm25_tempcov        = as.numeric(pm25_tempcov),
    no2_tempcov         = as.numeric(no2_tempcov),
    population          = as.numeric(population)
  )

# Convert categorical variables to factor
air_data <- air_data %>%
  mutate(
    who_region       = as.factor(who_region),
    iso3             = as.factor(iso3),
    country_name     = as.factor(country_name),
    city             = as.factor(city),
    type_of_stations = as.factor(type_of_stations),
    version          = as.factor(version)
  )

# Convert year to integer (if needed)
air_data <- air_data %>%
  mutate(year = as.integer(year))

summary(air_clean)

```



```{r}

air_data_scenarioA <- air_data %>%
  select(year, country_name, who_region, city,
         pm10_concentration, pm25_concentration, no2_concentration,
         pm10_tempcov, pm25_tempcov, no2_tempcov, population) %>%
  mutate(
    year = as.integer(year),
    country_name = as.factor(country_name),
    who_region = as.factor(who_region),
    city = as.factor(city),
    pm10_concentration = as.numeric(pm10_concentration),
    pm25_concentration = as.numeric(pm25_concentration),
    no2_concentration = as.numeric(no2_concentration),
    pm10_tempcov = as.numeric(pm10_tempcov),
    pm25_tempcov = as.numeric(pm25_tempcov),
    no2_tempcov = as.numeric(no2_tempcov),
    population = as.numeric(population)
  )
air_data
```


```{r}
glimpse(air_data)

```


```{r}
library(dplyr)

# Remove rows with NA in the specified columns
air_clean <- air_data %>%
  filter(
    !is.na(pm10_concentration),
    !is.na(pm25_concentration),
    !is.na(no2_concentration),
    !is.na(population)
  )
air_clean
```

```{r}
str(air_clean)
```
```{r}
#  Library load
library(dplyr)

# Filter 4_Eur region, 2010–2022, remove pm25 NA
air_region <- air_data %>%
  filter(
    who_region == "4_Eur",
    year >= 2010 & year <= 2022,
    !is.na(pm25_concentration)   # main pollutant NA remove
  ) %>%
  mutate(
    year = as.integer(year),
    pm10_concentration = as.numeric(pm10_concentration),
    pm25_concentration = as.numeric(pm25_concentration),
    no2_concentration  = as.numeric(no2_concentration),
    population         = as.numeric(population),
    country_name       = as.factor(country_name),
    city               = as.factor(city)
  )

# Remove rows with NA in main columns
air_region_clean <- air_region %>%
  filter(
    !is.na(pm10_concentration),
    !is.na(pm25_concentration),
    !is.na(no2_concentration),
    !is.na(population)
  )

#  Check structure
str(air_region_clean)


```
```{r}
spain_cities <- air_region_clean %>%
  filter(country_name == "Spain") %>%
  select(city) %>%
  distinct() %>%
  arrange(city)

head(spain_cities, 20)


```


```{r}


library(tidyverse)

```

```{r}
# summarise & save to region_trends
region_trends <- air_region %>%
  group_by(year) %>%
  summarise(
    avg_pm25 = mean(pm25_concentration, na.rm = TRUE),
    avg_pm10 = mean(pm10_concentration, na.rm = TRUE),
    avg_no2  = mean(no2_concentration, na.rm = TRUE),
    .groups = 'drop'
  )

# show first few rows
head(region_trends)

```

```{r}

# : Yearly trends visualization

# Function to create line plots
plot_trend <- function(data, y_var, y_label, color){
  ggplot(data, aes(x = year, y = !!sym(y_var))) +
    geom_line(color = color, size = 1.2) +
    geom_point(color = color, size = 2) +
    labs(title = paste(y_label, "Trend in Region 4_Eur (2010-2022)"),
         x = "Year", y = y_label) +
    scale_x_continuous(breaks = seq(2010, 2022, 1)) +
    theme_minimal()
}

# PM2.5
plot_trend(region_trends, "avg_pm25", "PM2.5 (µg/m³)", "blue")

# PM10
plot_trend(region_trends, "avg_pm10", "PM10 (µg/m³)", "green")

# NO2
plot_trend(region_trends, "avg_no2", "NO2 (µg/m³)", "red")

```
```{r}
# : Country-level comparison (PM2.5)

country_trends <- air_region %>%
  group_by(year, country_name) %>%
  summarise(
    avg_pm25 = mean(pm25_concentration, na.rm = TRUE),
    .groups = 'drop'
  )

# :countries with highest PM2.5 in 2022
top_countries_2022 <- country_trends %>%
  filter(year == 2022) %>%
  arrange(desc(avg_pm25)) %>%
  slice_head(n = 5)

top_countries_2022

# Visualize PM2.5 trends for top countries
top_country_names <- top_countries_2022$country_name

country_trends_top <- country_trends %>%
  filter(country_name %in% top_country_names)

ggplot(country_trends_top, aes(x = year, y = avg_pm25, color = country_name)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(title = "PM2.5 Trend for Top 5 Polluted Countries in 4_Eur (2010-2022)",
       x = "Year", y = "Average PM2.5 (µg/m³)", color = "Country") +
  scale_x_continuous(breaks = seq(2010, 2022, 1)) +
  theme_minimal()

```

```{r}
# Summary statistics & % change

summary_stats <- region_trends %>%
  summarise(
    mean_pm25 = mean(avg_pm25, na.rm = TRUE),
    mean_pm10 = mean(avg_pm10, na.rm = TRUE),
    mean_no2  = mean(avg_no2, na.rm = TRUE),
    min_pm25  = min(avg_pm25, na.rm = TRUE),
    max_pm25  = max(avg_pm25, na.rm = TRUE),
    min_pm10  = min(avg_pm10, na.rm = TRUE),
    max_pm10  = max(avg_pm10, na.rm = TRUE),
    min_no2   = min(avg_no2, na.rm = TRUE),
    max_no2   = max(avg_no2, na.rm = TRUE)
  )
summary_stats
```


```{r}
# Check correlation between pollutants
pollutant_corr <- air_region %>%
  select(pm10_concentration, pm25_concentration, no2_concentration) %>%
  cor(use = "pairwise.complete.obs")

# Print correlation matrix
print(pollutant_corr)



```
```{r}
install.packages("GGally")


```


```{r}
# Visualize correlation
library(GGally)
ggpairs(air_region, columns = c("pm10_concentration","pm25_concentration","no2_concentration"),
        title = "Correlation between PM10, PM2.5 and NO2 in 4_Eur")


```

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)


# : Filter data for Region 4_Eur and years 2010–2022

air_region_filtered <- air_region %>%
  filter(who_region == "4_Eur",
         year >= 2010 & year <= 2022) %>%
  select(year, pm25_concentration, pm10_concentration, no2_concentration)



# : Calculate yearly averages

region_trends <- air_region_filtered %>%
  group_by(year) %>%
  summarise(
    avg_pm25 = mean(pm25_concentration, na.rm = TRUE),
    avg_pm10 = mean(pm10_concentration, na.rm = TRUE),
    avg_no2  = mean(no2_concentration, na.rm = TRUE),
    .groups = 'drop'
  )


# : Transform to long format for plotting

pollutants_long <- region_trends %>%
  pivot_longer(
    cols = c(avg_pm25, avg_pm10, avg_no2),
    names_to = "pollutant",
    values_to = "value"
  )


# : Plot comparison of pollutants

ggplot(pollutants_long, aes(x = year, y = value, color = pollutant)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Comparison of PM2.5, PM10, and NO2 in Region 4_Eur (2010-2022)",
    x = "Year",
    y = "Average Concentration (µg/m³)",
    color = "Pollutant"
  ) +
  scale_x_continuous(breaks = seq(2010, 2022, 1)) +
  theme_minimal()


# : Summary statistics

summary(region_trends)



```
```{r}
install.packages("ggplot2")
```


```{r}
library(ggplot2)

#visualize distribution of PM2.5 across years
ggplot(air_region, aes(x = factor(year), y = pm25_concentration)) +
  geom_boxplot(fill = "skyblue", alpha = 0.5) +
  labs(title = "Distribution of PM2.5 Concentration per Year in 4_Eur",
       x = "Year", y = "PM2.5 (µg/m³)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
library(dplyr)

# Trend interpretation helper

# Compute % change of PM2.5 over the period
pm25_start <- region_trends %>% filter(year == 2010) %>% pull(avg_pm25)
pm25_end   <- region_trends %>% filter(year == 2022) %>% pull(avg_pm25)
pm25_change_pct <- ((pm25_end - pm25_start) / pm25_start) * 100
pm25_change_pct

# Similarly for PM10 and NO2
pm10_start <- region_trends %>% filter(year == 2010) %>% pull(avg_pm10)
pm10_end   <- region_trends %>% filter(year == 2022) %>% pull(avg_pm10)
pm10_change_pct <- ((pm10_end - pm10_start) / pm10_start) * 100

no2_start <- region_trends %>% filter(year == 2010) %>% pull(avg_no2)
no2_end   <- region_trends %>% filter(year == 2022) %>% pull(avg_no2)
no2_change_pct <- ((no2_end - no2_start) / no2_start) * 100



```


```{r}

# Highest polluted cities (2010–2022)

library(tidyverse)

#  PM2.5 
top_cities_pm25_all <- air_region %>%
  filter(year >= 2010 & year <= 2022) %>%
  group_by(country_name, city) %>%
  summarise(avg_pm25 = mean(pm25_concentration, na.rm = TRUE)) %>%
  arrange(desc(avg_pm25)) %>%
  slice_head(n = 10)

#  PM10 
top_cities_pm10_all <- air_region %>%
  filter(year >= 2010 & year <= 2022) %>%
  group_by(country_name, city) %>%
  summarise(avg_pm10 = mean(pm10_concentration, na.rm = TRUE)) %>%
  arrange(desc(avg_pm10)) %>%
  slice_head(n = 10)

#  NO2 
top_cities_no2_all <- air_region %>%
  filter(year >= 2010 & year <= 2022) %>%
  group_by(country_name, city) %>%
  summarise(avg_no2 = mean(no2_concentration, na.rm = TRUE)) %>%
  arrange(desc(avg_no2)) %>%
  slice_head(n = 10)

# Output print 
cat("==== Top 10 Cities (2010–2022) – PM2.5 ====\n")
print(top_cities_pm25_all)
cat("\n==== Top 10 Cities (2010–2022) – PM10 ====\n")
print(top_cities_pm10_all)
cat("\n==== Top 10 Cities (2010–2022) – NO2 ====\n")
print(top_cities_no2_all)


```



```{r}
# Interpretation (example statements for report)

cat("\nInterpretation:\n")
if(pm25_change_pct < 0){
  cat("PM2.5 decreased by", round(abs(pm25_change_pct),2), "% → slight improvement in air quality.\n")
} else {
  cat("PM2.5 increased by", round(pm25_change_pct,2), "% → air quality worsened.\n")
}

if(pm10_change_pct < 0){
  cat("PM10 decreased by", round(abs(pm10_change_pct),2), "% → improvement.\n")
} else {
  cat("PM10 increased by", round(pm10_change_pct,2), "% → worsened.\n")
}

if(no2_change_pct < 0){
  cat("NO2 decreased by", round(abs(no2_change_pct),2), "% → improvement.\n")
} else {
  cat("NO2 increased by", round(no2_change_pct,2), "% → worsened.\n")
}

```

```{r}

# Identify top 10 cities by PM2.5
top_cities_pm25 <- air_clean %>%
  group_by(country_name, city) %>%
  summarise(avg_pm25 = mean(pm25_concentration, na.rm = TRUE)) %>%
  arrange(desc(avg_pm25)) %>%
  slice_head(n = 10)

print(top_cities_pm25)

```
```{r}
library(tidyverse)

# Region Trends (2010–2022) – 4_Eur

region_trends <- air_clean %>%
  filter(who_region == "4_Eur", year >= 2010 & year <= 2022) %>%
  group_by(year) %>%
  summarise(
    avg_pm25 = mean(pm25_concentration, na.rm = TRUE),
    avg_pm10 = mean(pm10_concentration, na.rm = TRUE),
    avg_no2  = mean(no2_concentration, na.rm = TRUE),
    .groups = 'drop'
  )

head(region_trends)


# Pivot longer for plotting

region_trends_long <- region_trends %>%
  pivot_longer(cols = c(avg_pm25, avg_pm10, avg_no2),
               names_to = "pollutant",
               values_to = "avg_value")


# Final Line Chart

ggplot(region_trends_long, aes(x = year, y = avg_value, color = pollutant, group = pollutant)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "Air Pollution Trend (PM2.5, PM10, NO₂) in Region 4_Eur (2010–2022)",
    x = "Year",
    y = "Average Concentration (µg/m³)",
    color = "Pollutant"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    legend.position = "top"
  )




```
```{r}
region_trends <- air_clean %>%
  filter(who_region == "4_Eur", year >= 2010 & year <= 2022) %>%
  group_by(year) %>%
  summarise(
    avg_pm25 = mean(pm25_concentration, na.rm = TRUE),
    avg_pm10 = mean(pm10_concentration, na.rm = TRUE),
    avg_no2  = mean(no2_concentration, na.rm = TRUE),
    .groups = 'drop'
  )
head(region_trends)



```
```{r}
library(tidyr)
long_data <- region_trends %>%
  pivot_longer(cols = c(avg_pm25, avg_pm10, avg_no2), names_to = "pollutant", values_to = "concentration")

ggplot(long_data, aes(x = year, y = concentration, color = pollutant)) +
  geom_line(size = 1.2) +
  labs(title = "Yearly Trends of Pollutants in Europe", x = "Year", y = "Average Concentration (µg/m³)") +
  theme_minimal()

```





```{r}
# Percentage change calculation for PM2.5
pm25_start <- region_trends %>% filter(year == 2010) %>% pull(avg_pm25)
pm25_end   <- region_trends %>% filter(year == 2022) %>% pull(avg_pm25)
pm25_change_pct <- ((pm25_end - pm25_start) / pm25_start) * 100
pm25_change_pct



```


