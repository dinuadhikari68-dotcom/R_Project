---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 


```{r}
library(tidyverse)
```

```{r}
library(readxl)

air_data <- read_excel("who_ambient_air_quality_database_version_2024_(v6.1) (3).xlsx", 
                       sheet = "Update 2024 (V6.1)")

head(air_data)

```

```{r}
# Remove missing values for key columns (example: year and PM2.5)
air_clean <- air_data %>%
  filter(!is.na(pm25_concentration), !is.na(year)) %>%
  filter(year >= 2010 & year <= 2022)

# Convert data types
air_clean$year <- as.numeric(air_clean$year)

# Check summary
summarytools::dfSummary(air_clean)

```


```{r}
# Load tidyverse for convenient data manipulation
library(tidyverse)

# Convert numeric variables (from character to numeric)
air_data <- air_data %>%
  mutate(
    pm10_concentration  = as.numeric(pm10_concentration),
    pm25_concentration  = as.numeric(pm25_concentration),
    no2_concentration   = as.numeric(no2_concentration),
    pm10_tempcov        = as.numeric(pm10_tempcov),
    pm25_tempcov        = as.numeric(pm25_tempcov),
    no2_tempcov         = as.numeric(no2_tempcov),
    population          = as.numeric(population)
  )

# Convert categorical variables to factor
air_data <- air_data %>%
  mutate(
    who_region       = as.factor(who_region),
    iso3             = as.factor(iso3),
    country_name     = as.factor(country_name),
    city             = as.factor(city),
    type_of_stations = as.factor(type_of_stations),
    version          = as.factor(version)
  )

# Convert year to integer (if needed)
air_data <- air_data %>%
  mutate(year = as.integer(year))



```



```{r}

air_data_scenarioA <- air_data %>%
  select(year, country_name, who_region, city,
         pm10_concentration, pm25_concentration, no2_concentration,
         pm10_tempcov, pm25_tempcov, no2_tempcov, population) %>%
  mutate(
    year = as.integer(year),
    country_name = as.factor(country_name),
    who_region = as.factor(who_region),
    city = as.factor(city),
    pm10_concentration = as.numeric(pm10_concentration),
    pm25_concentration = as.numeric(pm25_concentration),
    no2_concentration = as.numeric(no2_concentration),
    pm10_tempcov = as.numeric(pm10_tempcov),
    pm25_tempcov = as.numeric(pm25_tempcov),
    no2_tempcov = as.numeric(no2_tempcov),
    population = as.numeric(population)
  )

```


```{r}
glimpse(air_data)
``
```


```{r}
library(dplyr)

# Remove rows with NA in the specified columns
air_clean <- air_data %>%
  filter(
    !is.na(pm10_concentration),
    !is.na(pm25_concentration),
    !is.na(no2_concentration),
    !is.na(population)
  )
```

```{r}
str(air_clean)
```
```{r}
#  Library load
library(dplyr)

# Filter 4_Eur region, 2010â€“2022, remove pm25 NA
air_region <- air_data %>%
  filter(
    who_region == "4_Eur",
    year >= 2010 & year <= 2022,
    !is.na(pm25_concentration)   # main pollutant NA remove
  ) %>%
  mutate(
    year = as.integer(year),
    pm10_concentration = as.numeric(pm10_concentration),
    pm25_concentration = as.numeric(pm25_concentration),
    no2_concentration  = as.numeric(no2_concentration),
    population         = as.numeric(population),
    country_name       = as.factor(country_name),
    city               = as.factor(city)
  )

# Remove rows with NA in main columns
air_region_clean <- air_region %>%
  filter(
    !is.na(pm10_concentration),
    !is.na(pm25_concentration),
    !is.na(no2_concentration),
    !is.na(population)
  )

#  Check structure
str(air_region_clean)


```
```{r}
spain_cities <- air_region_clean %>%
  filter(country_name == "Spain") %>%
  select(city) %>%
  distinct() %>%
  arrange(city)

head(spain_cities, 20)


```





